## from meshes.R



if(FALSE){
    trajectory <- as_tibble(trajectory %>% distinct(session_id, position_x, position_y)) %>%
        dplyr::filter(session_id %in% spatial_firing$session_id) %>% arrange(session_id) %>%
        mutate(X = map2(position_x, position_y, function(x, y) na.omit(data.frame( position_x = x, position_y = y)))) %>%
        mutate(mycoords = lapply(X, function(x) SpatialPoints(x))) %>%
        mutate(Pl = lapply(X, function(x) Polygon(as.matrix(x)))) %>%
        mutate(Pls  = lapply(Pl, function(x) Polygons(list(x), ID="[0,1]x[0,1]"))) %>% 
        mutate(SPls = lapply(Pls, function(x) SpatialPolygons(list(x)))) %>% 
        mutate(trajectory = lapply(SPls, function(x) SpatialPolygonsDataFrame(x, df)))


    spatial_firing <- as_tibble(spatial_firing) %>% 
        mutate(Y = map2(position_x, position_y, function(x, y) na.omit(data.frame( position_x = x, position_y = y)))) %>%
        mutate(nrowY = unlist(lapply(Y, function(x) dim(as.matrix(x))[1]))) %>%    
        group_by(session_id) %>% mutate(cond = as.numeric(nrowY == min(nrowY))) %>% ungroup() %>% 
        dplyr::filter(cond==1) %>% arrange(session_id) %>%
        mutate(mycoords = lapply(Y, function(x) SpatialPoints(x))) %>% filter(any(nrowY==min(nrowY)))


    df <-  data.frame(value=1, row.names="[0,1]x[0,1]")
    X  <- vector('list', dim(trajectory)[1])
    Y  <- vector('list', dim(trajectory)[1])

    ##
    for(i in 1:dim(trajectory)[1]){
        X[[i]] = data.frame(position_x = trajectory$position_x[i][[1]],    
                            position_y = trajectory$position_y[i][[1]] )
        ## 
        Y[[i]] = data.frame(position_x = spatial_firing$position_x[i][[1]],    
                            position_y = spatial_firing$position_y[i][[1]],
                            hd = spatial_firing$hd[i][[1]] )
    }

    for(i in 1:dim(trajectory)[1]){
        Sys.sleep(3)
        plot(X[[i]], type="l", asp=1)
        points(Y[[i]], col=2, pch=16)
        lines(X[[i]], type="l", asp=1)
    }
}
## 
## pdf(file="trajectory110_spatialfiring349.pdf")
## dev.off()
## 


    



if(FALSE){
    spatial_firing <- as_tibble(spatial_firing) %>%
        mutate(Y = map2(position_x, position_y, function(x, y) na.omit(data.frame( position_x = x, position_y = y)))) 
    spatial_firing <- as_tibble(spatial_firing %>% distinct(session_id, .keep_all=TRUE)) %>% arrange(session_id) %>%
        mutate(Y = map2(position_x, position_y, function(x, y) na.omit(data.frame( position_x = x, position_y = y)))) %>%
        mutate(mycoords = lapply(Y, function(x) SpatialPoints(x)))
}

for(i in 1:dim(trajectory)){
    Sys.sleep(1)

    pdf(file="/home/ipapasta/Desktop/image3.pdf")
    plot(trajectory$trajectory[[55]])
    points(spatial_firing$Y[[55]], col=2, pch=16, cex=0.5)
    dev.off()
}


plot(trajectory)
points(mycoords, pch=16, col=2)
